import sys

from bento.commands import hooks

@hooks.pre_build
def pre_build(context):
    bld = context.waf_context
    f2py = bld.tools["f2py"]

    def builder(extension):
        source = extension.sources[:]
        if sys.platform == "darwin":
            source.pop(source.index("fblaswrap.f.src"))
            source.append("fblaswrap_veclib_c.c.src")
        bld(features="c fc pyext bento cshlib f2py",
            source=source,
            target=extension.name,
            use="FBLAS")
    context.register_builder("fblas", builder)

    def builder(extension):
        if bld.env.HAS_CBLAS:
            bld(features="c fc pyext bento cshlib f2py",
                source=extension.sources,
                target=extension.name,
                use="CBLAS")
        else:
            bld(features="c fc pyext bento cshlib f2py",
                source=extension.sources,
                target=extension.name,
                )
    context.register_builder("cblas", builder)
